<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>用WindowsADK创建WinPE | 技术博客</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel=stylesheet><style>:root{--nav-height:60px;--toc-width:280px;--content-padding:40px;--primary-color:#3498db;--text-color:#333;--light-gray:#f5f5f5;--border-color:#eaeaea}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;color:var(--text-color);line-height:1.6;padding-top:var(--nav-height);overflow-x:hidden}.top-nav{position:fixed;top:0;left:0;right:0;height:var(--nav-height);background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;align-items:center;padding:0 30px;z-index:1000}.nav-container{width:100%;max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}.site-title{font-size:1.4rem;font-weight:700;color:var(--primary-color);text-decoration:none}.nav-links{display:flex;gap:25px}.nav-links a{color:var(--text-color);text-decoration:none;font-size:1rem;transition:color .3s}.nav-links a:hover{color:var(--primary-color)}.main-container{display:flex;max-width:1400px;margin:0 auto;padding:20px}.toc-container{position:sticky;top:calc(var(--nav-height) + 20px);align-self:flex-start;width:var(--toc-width);padding:20px;margin-right:30px;max-height:calc(100vh - var(--nav-height) - 40px);overflow-y:auto;background:var(--light-gray);border-radius:8px;scroll-behavior:auto;overscroll-behavior:contain}.toc-title{font-size:1.2rem;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid var(--primary-color)}.toc ul{list-style:none;padding-left:15px}.toc li{margin-bottom:8px;position:relative}.toc a{color:var(--text-color);text-decoration:none;display:block;padding:5px 0 5px 10px;transition:all .2s;font-size:.95rem;border-left:2px solid transparent}.toc a:hover{color:var(--primary-color);transform:translateX(5px)}.toc a.active{color:var(--primary-color);font-weight:700;border-left:3px solid var(--primary-color);background:rgba(52,152,219,5%);transform:translateX(5px)}.content-container{flex:1;background:#fff;padding:var(--content-padding);border-radius:8px;box-shadow:0 2px 15px rgba(0,0,0,5%)}.article-header{margin-bottom:30px;border-bottom:1px solid var(--border-color);padding-bottom:20px}.article-title{font-size:2rem;margin-bottom:10px;color:#2c3e50}.article-meta{display:flex;gap:20px;color:#7f8c8d;font-size:.9rem;margin-bottom:15px}.article-content{line-height:1.8}.article-content h2{font-size:1.6rem;margin:2rem 0 1rem;padding-bottom:.5rem;border-bottom:1px solid var(--border-color);scroll-margin-top:calc(var(--nav-height) + 20px)}.article-content h3{font-size:1.3rem;margin:1.5rem 0 .8rem;scroll-margin-top:calc(var(--nav-height) + 20px)}.article-content img{max-width:100%;height:auto;border-radius:6px;margin:1.5rem 0;box-shadow:0 3px 10px rgba(0,0,0,.1)}.article-content pre{position:relative;background:#f7f7f7;color:#242424;border-left:4px solid #04b04f;border-radius:8px;padding:1.5rem 1rem 1rem;margin:1.5rem 0;overflow:auto;box-shadow:0 1px 3px rgba(0,0,0,.1);max-height:40vh;white-space:pre-wrap;font-family:fira code,Menlo,Monaco,Consolas,monospace;font-size:.9rem;line-height:1.5;scrollbar-width:thin;scrollbar-color:#c4c4c4 #f7f7f7}.article-content code{font-family:inherit;color:inherit !important;background:0 0 !important;padding:0;text-shadow:none !important;font-size:.9rem}.hljs-meta,.hljs-built_in{color:#04b04f}.hljs-attribute{color:#e91e63}.hljs-string{color:#2e7d32}.hljs-number{color:#2196f3}.article-content pre::-webkit-scrollbar{width:12px;height:12px}.article-content pre::-webkit-scrollbar{width:12px;height:12px}.article-content pre::-webkit-scrollbar-thumb{background:#04b04f;opacity:.6;border:3px solid #f7f7f7}.article-content pre::-webkit-scrollbar-track{background:#f7f7f7;border-radius:6px}.copy-code{position:absolute;top:10px;right:15px;background:rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.2);color:#242424;border-radius:4px;padding:3px 8px;font-size:.8rem;cursor:pointer;transition:all .3s;opacity:0;z-index:10}pre:hover .copy-code{opacity:1}.copy-code:hover{background:rgba(0,0,0,.2)}.copy-code.copied{background:#28a745;color:#fff;border-color:#28a745}@media(max-width:1024px){.toc-container{width:240px;padding:15px}.content-container{padding:25px}}@media(max-width:768px){.main-container{flex-direction:column}.toc-container{position:static;width:100%;margin-right:0;margin-bottom:30px;max-height:none}.article-title{font-size:1.8rem}.article-content pre{max-height:50vh;padding-right:10px}}</style></head><body><nav class=top-nav><div class=nav-container><a href=/ class=site-title>技术博客</a><div class=nav-links><a href=/>首页</a>
<a href=/posts/>所有文章</a>
<a href=/categories/>分类</a>
<a href=/tags/>标签</a></div></div></nav><div class=main-container><aside class=toc-container><h3 class=toc-title>目录</h3><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#安装windows-adk-及winpe加载项>安装Windows ADK 及Winpe加载项</a><ul><li><a href=#下载并安装-windows-adk><a href=https://learn.microsoft.com/zh-cn/windows-hardware/get-started/adk-install#other-adk-downloads>下载并安装 Windows ADK</a></a></li><li><a href=#下载并安装winpe加载项><a href="https://go.microsoft.com/fwlink/?linkid=2022233">下载并安装WinPe加载项</a></a></li></ul></li><li><a href=#创建基础的winpe>创建基础的Winpe</a><ul><li><a href=#一行命令创建基础winpe>一行命令创建基础Winpe</a></li><li><a href=#制作可启动的u盘或者可启动的iso镜像文件>制作可启动的U盘或者可启动的ISO镜像文件</a></li><li><a href=#微软公司关于winpe的文档>微软公司关于WinPE的文档</a></li></ul></li><li><a href=#扩展基础winpe功能>扩展基础Winpe功能</a><ul><li><a href=#winpe工作目录及注册表权限的设置>Winpe工作目录及注册表权限的设置</a></li><li><a href=#修改注册表>修改注册表</a></li><li><a href=#添加exlorer支持文件>添加Exlorer支持文件</a></li><li><a href=#手动添加常用软件>手动添加常用软件</a></li><li><a href=#简单总结>简单总结</a></li></ul></li></ul></li></ul></nav></div></aside><article class=content-container><header class=article-header><h1 class=article-title>用WindowsADK创建WinPE</h1><div class=article-meta><span>📅 2023年6月8日</span></div></header><div class=article-content><h3 id=安装windows-adk-及winpe加载项>安装Windows ADK 及Winpe加载项</h3><h4 id=下载并安装-windows-adk><a href=https://learn.microsoft.com/zh-cn/windows-hardware/get-started/adk-install#other-adk-downloads>下载并安装 Windows ADK</a></h4><p>查看windows系统的版本号，下载对应版本的ADK,运行adksetup。</p><p>​ <img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/adk_winpe.png></p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/adk-setup.png></p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/adk-setup2.png></p><h4 id=下载并安装winpe加载项><a href="https://go.microsoft.com/fwlink/?linkid=2022233">下载并安装WinPe加载项</a></h4><p>下载对应版本的WINpe加载项并安装</p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/winpe-load.png></p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/winpe-load2.png></p><h3 id=创建基础的winpe>创建基础的Winpe</h3><ul><li><p>安装好ADK和WInpe加载项之后，点击Windows桌面左下角的Windows图标，打开程序菜单，选择【部署和映像工具环境】</p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/deploy_tools_env.png></p></li></ul><h4 id=一行命令创建基础winpe>一行命令创建基础Winpe</h4><p>打开CMD窗口后运行下面的命令：</p><p>copype amd64 d:\win10pe</p><p>执行结果如下图：</p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/copype.png></p><p>如果没有选择从【部署和映像工具环境】打开CMD窗口，而是在CMD窗口中手动切换目录到部署和映像工具所在的目录，使用copype命令时会提示找不到amd64架构处理器，如下图所示：</p><p><img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/copype_err.png>
出现这个问题的根本原因是设置环境变量的问题，如果要手动执行的话，就需要自己修改copype.cmd里的脚本，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rem
</span></span><span class=line><span class=cl>rem Set environment variables <span class=k>for</span> use in the script
</span></span><span class=line><span class=cl>rem
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nv>WINPE_ARCH</span><span class=o>=</span>%1
</span></span><span class=line><span class=cl>**set <span class=nv>WinPERoot</span><span class=o>=</span>C:<span class=se>\P</span>rogram Files <span class=o>(</span>x86<span class=o>)</span><span class=se>\W</span>indows Kits<span class=se>\1</span>0<span class=se>\A</span>ssessment and Deployment Kit<span class=se>\W</span>indows Preinstallation Environment**
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nv>SOURCE</span><span class=o>=</span>%WinPERoot%<span class=se>\%</span>WINPE_ARCH%
</span></span><span class=line><span class=cl>**set <span class=nv>OSCDImgRoot</span><span class=o>=</span>C:<span class=se>\P</span>rogram Files <span class=o>(</span>x86<span class=o>)</span><span class=se>\W</span>indows Kits<span class=se>\1</span>0<span class=se>\A</span>ssessment and Deployment Kit<span class=se>\D</span>eployment Tools<span class=se>\a</span>md64<span class=se>\O</span>scdimg**
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nv>FWFILESROOT</span><span class=o>=</span>%OSCDImgRoot%<span class=se>\.</span>.<span class=se>\.</span>.<span class=se>\%</span>WINPE_ARCH%<span class=se>\O</span>scdimg
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nv>DEST</span><span class=o>=</span>%~2
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=nv>WIMSOURCEPATH</span><span class=o>=</span>%SOURCE%<span class=se>\e</span>n-us<span class=se>\w</span>inpe.wim
</span></span></code></pre></div><p>这段代码是引用自CSDN上一个博主的文章<a href=https://blog.csdn.net/weixin_43863487/article/details/116117714>win10PE iso镜像制作及问题解决</a></p><h4 id=制作可启动的u盘或者可启动的iso镜像文件>制作可启动的U盘或者可启动的ISO镜像文件</h4><p><code>MakeWinpeMedia /UFD d:\win10pe X:</code></p><p><code>MakeWinPEMedia /ISO d:\win10pe d:\win10pe\WinPE_amd64.iso</code></p><p>总结一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>1、下载并安装Windows ADK及WinPE加载项
</span></span><span class=line><span class=cl>2、以管理员权限运行开始菜单的【部署和映像工具环境】
</span></span><span class=line><span class=cl>3、运行copye    amd64   d:<span class=se>\w</span>in10pe
</span></span><span class=line><span class=cl>4、制作可启动的U盘或者ISO映像
</span></span><span class=line><span class=cl>   MakeWinpeMedia   /UFD    d:<span class=se>\w</span>in10pe   X:
</span></span><span class=line><span class=cl>   MakeWinpeMedia   /ISO    d:<span class=se>\w</span>in10pe   d:<span class=se>\w</span>in10pe<span class=se>\w</span>in10pe.iso   
</span></span><span class=line><span class=cl>5、使用制作好的U盘启动，运行只有CMD窗口的Winpe
</span></span><span class=line><span class=cl>  * 运行notepad
</span></span><span class=line><span class=cl>  * 选择File /open，打开文件系统浏览器，查看下载好的Windows安装盘所在的驱动器和目录（可以提前把下载好的原版Windows安装盘解压到指定驱动器或者另外一个U盘）
</span></span><span class=line><span class=cl>  * 切换到安装文件所在的目录，运行setup,就可以在CMD窗口下完成Windows安装
</span></span><span class=line><span class=cl>  如果不满足于基础的命令窗口的WinPE，继续往下进行。
</span></span></code></pre></div><h4 id=微软公司关于winpe的文档>微软公司关于WinPE的文档</h4><h5 id=download-windows-pe-winpe><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/download-winpe--windows-pe?view=windows-11">Download Windows PE (WinPE)</a></h5><h5 id=create-bootable-windows-pe-media><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-create-usb-bootable-drive?view=windows-11">Create bootable Windows PE media</a></h5><h5 id=winpe-mount-and-customize><a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-mount-and-customize?view=windows-11">WinPE: Mount and Customize</a></h5><h3 id=扩展基础winpe功能>扩展基础Winpe功能</h3><h4 id=winpe工作目录及注册表权限的设置>Winpe工作目录及注册表权限的设置</h4><ul><li><p>鼠标右击目录winpe-amd64(Winpe所在的工作目录)，选择属性，在弹出的对话框中选择安全标签，点击高级。如下图所示：</p><p><img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/security-1.png></p></li><li><p>更改目录的所有者为当前用户(如果不清楚当前用户名，可在cmd命令窗口下用whoami命令显示当前用户名)。</p><p><img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/owner-1.png></p><p>​ <img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/search.png>
<img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/selections.png></p></li><li><p>为当前用户添加权限</p><p><img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/add-1.png>
<img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/add-2.png>
<img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/add-3.png>
<img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/add-4.png></p><p>总结一下添加权限的基本步骤</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>1、把工作目录的所有者更改为当前用户。如果不知道当前登录Windows的用户名，在CMD窗口下使用whoami命令查询
</span></span><span class=line><span class=cl>2、为当前用户添加权限
</span></span><span class=line><span class=cl>3、注意事项：继承和替换子容器和对象的所有者两个选项都要选，添加权限时选择全部权限。在下一节中修改注册表也用同样方法设置权限。
</span></span></code></pre></div><h4 id=修改注册表>修改注册表</h4></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>1、把前边制作好的基础Winpe的boot.wim加载到指定的目录，这里加载位置为hyper-v虚拟机的c盘（c:<span class=se>\w</span>inpe-amd64<span class=se>\m</span>ount）
</span></span><span class=line><span class=cl>   dism /mount-image /imagefile:c:<span class=se>\w</span>inpe-amd64<span class=se>\m</span>edia<span class=se>\s</span>ources<span class=se>\b</span>oot.wim /index:1 /mounddir:c:<span class=se>\w</span>inpe-amd64<span class=se>\m</span>ount
</span></span><span class=line><span class=cl>2、把制作Winpe的Windows10安装盘的install.wim也加载到指定的目录，这里加载的位置为c:<span class=se>\w</span>inpe-amd64<span class=se>\i</span>nstall
</span></span><span class=line><span class=cl>3、在winpe-amd64下新建两个目录，目录名称为<span class=o>[</span>原pe<span class=o>]</span>、<span class=o>[</span>原win10<span class=o>]</span>。上边两个wim包加载成功后，分别复制各自的windows<span class=se>\s</span>ystem32<span class=se>\c</span>onfig目录下四个注册表配置单元（SOFTWARE,SYSTEM、DEFAULT,DRIVERS），保存在<span class=o>[</span>原pe<span class=o>]</span>、<span class=o>[</span>原win10<span class=o>]</span>目录下。
</span></span><span class=line><span class=cl>4、备份好原pe和win10的注册表配置单元后，直接把原win10的software配置单元复制到boot.wim加载的对应目录下（也就是直接替换win10的注册表），后边的修改是以win10的注册表为基础，然后导出pe的注册表，确保pe注册表的正常运行，又具有win10的功能。
</span></span><span class=line><span class=cl>5、运行regedit,加载、修改、保存原pe的software配置单元。
</span></span><span class=line><span class=cl>  （1）加载。以管理员权限运行regedit（ctrl+shift+esc打开任务管理器，选择文件<span class=se>\运</span>行新任务，勾选<span class=o>[</span>系统管理原权限创建此任务<span class=o>]</span>，运行regedit）,选择HKEY-LOCAL-MACHINE,选择文件<span class=p>|</span>加载配置单元，选择前边第三步保存的<span class=o>[</span>原pe<span class=o>]</span>software配置单元，<span class=o>[</span>项名称<span class=o>]</span>指定为pe-soft。鼠标右击pe-soft,选择权限，设置方法前边已详细说明，先修改所有者、继承，再添加所有权限。
</span></span><span class=line><span class=cl>  （2）修改。关闭regedit,打开Registry Workshop.<span class=o>(</span>在卸载配置单元的时候不能 regedit和workshop 两个一起打开，不然会提示拒绝访问，只能关掉一个去另一个卸载配置单元。有时workshop操作完之后直接卸载也是拒绝访问，这个是它自身的问题，只能关了重开再去卸载，或者关了打开regedit卸载）<span class=o>)</span>,选择pe-soft,ctrl+F查找C:<span class=se>\和</span>D:<span class=se>\,</span>全部替换为X:<span class=se>\（</span>这里是大写的X）。查到后，在Registry Workshop的窗口的下面列出所有的搜索到的结果，ctrl+A全部选择这些搜索的结果，然后鼠标右击并选择替换，把C:<span class=se>\替</span>换为X:<span class=se>\；</span>同样的操作再搜索D:<span class=se>\,</span>也替换为X:<span class=se>\。</span>再搜索Interactive User，全部替换成空（不是删除<span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>(</span>3<span class=o>)</span>保存导出。修改完成后，右击pe-soft,选择导出，保存为pe-modified（名称随意），最后选择文件<span class=p>|</span>卸载配置单元，卸载掉pe-soft。这样就完成了对原pe的software的修改，并另存为pe-modified。
</span></span><span class=line><span class=cl>  （4）再加载前边第四步用win10的software替换的、加载到winpe-amd64<span class=se>\m</span>ount的windows<span class=se>\s</span>ystem32<span class=se>\c</span>onfig<span class=se>\s</span>oftwoare,同样命名为pe-soft,用同样的步骤和方法查询、替换C:<span class=se>\和</span>D:<span class=se>\为</span>X:<span class=se>\，</span>把Interactive User替换为空。修改完成后，直接双击运行pe-modified，把修改后的<span class=o>[</span>原pe<span class=o>]</span>导入到现在的pe，最后卸载pe-soft。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>总结一下：
</span></span><span class=line><span class=cl>1、（导出software注册表）修改Windows安装镜像的software注册表。使用7-zip打开win10安装镜像中的install.wim文件，提取windows<span class=se>\s</span>ystem32<span class=se>\s</span>oftware注册表文件到software目录<span class=o>(</span>自己新建自定义目录<span class=o>)</span>，然后按照上述方法修改<span class=o>(</span>修改工具为RegistyWorkShop<span class=o>)</span>，完成后卸载（卸载工具为windows自带的regedit）。
</span></span><span class=line><span class=cl>2、（修改）修改生成的基础winpe的boot.wim文件包的software注册表，并导出为xxx.reg文件，以备导入。使用7-zip打开生成的基础winpe下的boot.wim文件，提取windows<span class=se>\s</span>ystem32<span class=se>\s</span>oftware主表表文件到pe-software目录<span class=o>(</span>自己新建自定义目录<span class=o>)</span>，用同样的方法完成修改。
</span></span><span class=line><span class=cl>3、（合并）合并两个software注册表单元。把xxx.reg文件合并到修改后的win10安装镜像software注册表单元。
</span></span><span class=line><span class=cl>4、（替换）替换software注册表单元文件。 用合并后的software注册表单元文件替换基础wnipe的boot.wim对应文件
</span></span></code></pre></div><h4 id=添加exlorer支持文件>添加Exlorer支持文件</h4><p><a href=https://blog.csdn.net/qq_39819990/article/details/128518037>这里参照csdn网友文章的方法</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>一、使用tasklsit显示Explorer进程依赖的文件
</span></span><span class=line><span class=cl>1、Ctrl+Shift+Esc打开任务管理器，先点击左上角文件-运行新任务，输入cmd，勾选以系统管理权限创建此任务，粘贴但不运行以下命令
</span></span><span class=line><span class=cl>  explorer.exe <span class=p>|</span> tasklist /M /FI <span class=s2>&#34;ImageName eq explorer.exe&#34;</span> /FO LIST
</span></span><span class=line><span class=cl>2、鼠标右击任务管理中的Explorer.exe进程，选择结束进程。
</span></span><span class=line><span class=cl>3、在第一步打开的CMD窗口中粘贴并运行这条命令： explorer.exe <span class=p>|</span> tasklist /M /FI <span class=s2>&#34;ImageName eq explorer.exe&#34;</span> /FO LIST 
</span></span><span class=line><span class=cl>   开启explorer的同时使用tasklist显示explorer依赖文件
</span></span><span class=line><span class=cl>4、复制【模块】后边显示的所有文件，把文件列表保存在文本文件中，并去掉文件前边的空格（ctrl+h打开记事本的替换功能，把空格替换为空）
</span></span><span class=line><span class=cl>5、关掉刚才运行CMD命令窗口，新开一个CMD命令窗口，去掉前面explorer <span class=p>|</span>，运行 tasklist /M /FI <span class=s2>&#34;ImageName eq explorer.exe&#34;</span> /FO LIST 
</span></span><span class=line><span class=cl>  这里显示运行中的Explorer依赖的文件。启动时和运行中的Explorer依赖有可能不同，尽量找全依赖文件。这两个列表会有重复，接下来就是把两次导出的文件列表复制到Wps的表格中，把重复的文件去掉就可以得到完整的Explorer依赖文件。
</span></span><span class=line><span class=cl>6、有了详细的文件列表，就可以使用beyond compare4（循环搜索），找到文件后复制到PE文件列表中，也可以自己写脚本文件，使用Xcopy复制。要记得复制DLL目录<span class=o>(</span>System32等）<span class=se>\z</span>h-CN<span class=se>\x</span>x.mui文件（虽然有些DLL没有）和<span class=se>\W</span>indows<span class=se>\S</span>ystemResources<span class=se>\x</span>x.mun文件  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>二、使用Wimbuilder2的批处理收集Explorer依赖的文件
</span></span><span class=line><span class=cl>目录：WimBuilder2-Full.v2022-02-02<span class=se>\P</span>rojects<span class=se>\W</span>IN10XPE<span class=se>\0</span>1-Components<span class=se>\0</span>0-Shell<span class=se>\E</span>xplorer，文件为submain.bat
</span></span><span class=line><span class=cl>1.@+目录代表在xx目录的意思，@下面的文件就都是在那个目录才有的，此处先不考虑WOW64<span class=o>(</span>32位<span class=o>)</span>,先整完64位版本再说，
</span></span><span class=line><span class=cl>2.这里贴出来的都是要复制并替换进去的，包括第一行<span class=se>\W</span>indows<span class=se>\S</span>ystemResources<span class=se>\W</span>indows.UI.ShellCommon整个目录，
</span></span><span class=line><span class=cl>3.分号代表注释，解释说明下面的文件干啥用，也是全部复制并替换
</span></span><span class=line><span class=cl>4.*号通配符代表符合要求的所有文件，
</span></span><span class=line><span class=cl>5.+if代表判断是否符合要求，-if结束判断，这个也不用管，除了61-65行win11所有if都满足，但是不满足的那个if的文件也要。脚本列出的全部文件都要！
</span></span><span class=line><span class=cl>6.开始的desktop.ini是系统文件，需显示受保护的系统文件才看得见
</span></span><span class=line><span class=cl>7.记得复制.mui和ExplorerFrame.dll.mun（列表没有）、shell32.dll.mun!!!
</span></span><span class=line><span class=cl>8.前面2.1说的缺文件就是这个<span class=se>\W</span>indows<span class=se>\S</span>ystemResources<span class=se>\W</span>indows.UI.ShellCommon和ExplorerFrame.dll.mun、shell32.dll.mun等mun，复制进去差不多就到注册表修改了，要是注册表改完explorer还开启不了就再对比一下文件列表，添加功能，这里的文件列表把控制面板差不多都包含进去了
</span></span><span class=line><span class=cl>9.Win11壁纸<span class=se>\W</span>indows<span class=se>\W</span>eb<span class=se>\W</span>allpaper<span class=se>\W</span>indows<span class=se>\i</span>mg0.jpg也复制进去
</span></span><span class=line><span class=cl>10.可以自己改造脚本复制文件，建议直接bcompare
</span></span><span class=line><span class=cl>11.win11中找不到文件的我都标出来了
</span></span><span class=line><span class=cl>12.一定要复制<span class=se>\W</span>indows<span class=se>\S</span>ystem32<span class=se>\a</span>ctxprxy.dll及其.mui，少了这个东西explorer启动不了，还有shellstyle.dll，少了它explorer只能卡在全白的界面（列表中无）
</span></span><span class=line><span class=cl>13.想要win10/11那种窗口效果的替换uxtheme.dll，themeservice.dll,themeui.dll等与主题有关的dll及其mui，加入DWM那里有
</span></span><span class=line><span class=cl>14.壁纸的设置在下一章，修改pe-def的时候会提到，本文先让窗口版本的explorer启动起来先，要提前设置的可以跑到<span class=o>[</span>HKEY_LOCAL_MACHINE<span class=se>\p</span>e-def<span class=se>\C</span>ontrol Panel<span class=se>\D</span>esktop<span class=o>]</span>设置<span class=s2>&#34;Wallpaper&#34;</span><span class=o>=</span>“X:<span class=se>\W</span>indows<span class=se>\W</span>eb<span class=se>\W</span>allpaper<span class=se>\W</span>indows<span class=se>\i</span>mg0.jpg”
</span></span><span class=line><span class=cl>————————————————
</span></span><span class=line><span class=cl>原文链接：https://blog.csdn.net/qq_39819990/article/details/128518037
</span></span></code></pre></div><h4 id=手动添加常用软件>手动添加常用软件</h4><h5 id=以添加oscdimg为例说明向winpe中添加软件的方法>以添加oscdimg为例说明向winpe中添加软件的方法</h5><p>oscdimg是Windows ADK中带的一个工具，但是却并没有集成到winpe中，一般是在<code>C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\</code>下的amd64|arm|x86|arm64目录下。添加过程分为两步,添加软件和修改注册表。</p><ul><li><p>winpe的boot.wim挂载目录下新建一个目录(c:\winpe-amd64\mount\windows)，复制Oscdimg.exe和相关文件</p><ul><li><p>md c:\winpe-amd64\mout\Windows\Oscdimg</p></li><li><p>copy amd64\oscdimg c:\winpe-amd64\mout\Windows\Oscdimg</p></li></ul></li><li><p>设置注册表项</p><p>运行regedit ,选择HEKY-LOCAL-MACHE下的【SYSTEM\ControlSet001\Control\Session Manager\Environment】，在右侧的数据项中找到path ,在最后加上%SystemRoot%\Oscdimg ，中间用分号隔开。这里的%SystemRoot%是环境变量的写法，一般指Windows目录。</p></li></ul><p><img alt=img loading=lazy src=/posts/2023/%E7%94%A8windowsadk%E5%88%9B%E5%BB%BAwinpe/images/regedit-environment.png></p><h4 id=简单总结>简单总结</h4><ul><li><p>使用Windows ADK制作基础的winpe</p></li><li><p>再结合手动制作Winpe那篇文档，对Windows ADK制作好的基础winpe进行扩展</p><ul><li>导出 install.wim中的software注册表配置单元</li><li>导出基础winpe的software注册表配置单元</li><li>修改注册表（参照修改的细节）</li></ul></li><li><p>合并注册表</p><ul><li>用修改后的install.wim的software注册表配置单元覆盖基础winpe的software注册表配置单元</li></ul></li><li><p>添加Explorer支持文件</p></li></ul></div></article></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e);const t=document.createElement("button");t.className="copy-code",t.textContent="Copy",t.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{t.textContent="Copied!",t.classList.add("copied"),setTimeout(()=>{t.textContent="Copy",t.classList.remove("copied")},2e3)})}),e.parentElement.prepend(t)});const o=document.querySelectorAll(".article-content h2[id], .article-content h3[id]"),i=document.querySelectorAll('.toc a[href^="#"]'),a=document.querySelector(".top-nav").offsetHeight,n=document.querySelector(".toc-container"),e=[];o.forEach(t=>{e.push({id:t.id,top:t.offsetTop-a-20})});function s(){const s=window.scrollY;let t="";for(let n=e.length-1;n>=0;n--)if(e[n].top<=s+50){t=e[n].id;break}i.forEach(e=>{const s=e.getAttribute("href")===`#${t}`;if(e.classList.toggle("active",s),s){const t=e.offsetTop-n.clientHeight/2;n.scrollTop=t}})}let t=!1;window.addEventListener("scroll",()=>{t||(window.requestAnimationFrame(()=>{s(),t=!1}),t=!0)}),s()})</script></body></html>