<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用wimBuilder2制作winpe | 技术博客</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel=stylesheet><style>:root{--nav-height:60px;--toc-width:280px;--content-padding:40px;--primary-color:#3498db;--text-color:#333;--light-gray:#f5f5f5;--border-color:#eaeaea}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;color:var(--text-color);line-height:1.6;padding-top:var(--nav-height);overflow-x:hidden}.top-nav{position:fixed;top:0;left:0;right:0;height:var(--nav-height);background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;align-items:center;padding:0 30px;z-index:1000}.nav-container{width:100%;max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}.site-title{font-size:1.4rem;font-weight:700;color:var(--primary-color);text-decoration:none}.nav-links{display:flex;gap:25px}.nav-links a{color:var(--text-color);text-decoration:none;font-size:1rem;transition:color .3s}.nav-links a:hover{color:var(--primary-color)}.main-container{display:flex;max-width:1400px;margin:0 auto;padding:20px}.toc-container{position:sticky;top:calc(var(--nav-height) + 20px);align-self:flex-start;width:var(--toc-width);padding:20px;margin-right:30px;max-height:calc(100vh - var(--nav-height) - 40px);overflow-y:auto;background:var(--light-gray);border-radius:8px;scroll-behavior:auto;overscroll-behavior:contain}.toc-title{font-size:1.2rem;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid var(--primary-color)}.toc ul{list-style:none;padding-left:15px}.toc li{margin-bottom:8px;position:relative}.toc a{color:var(--text-color);text-decoration:none;display:block;padding:5px 0 5px 10px;transition:all .2s;font-size:.95rem;border-left:2px solid transparent}.toc a:hover{color:var(--primary-color);transform:translateX(5px)}.toc a.active{color:var(--primary-color);font-weight:700;border-left:3px solid var(--primary-color);background:rgba(52,152,219,5%);transform:translateX(5px)}.content-container{flex:1;background:#fff;padding:var(--content-padding);border-radius:8px;box-shadow:0 2px 15px rgba(0,0,0,5%)}.article-header{margin-bottom:30px;border-bottom:1px solid var(--border-color);padding-bottom:20px}.article-title{font-size:2rem;margin-bottom:10px;color:#2c3e50}.article-meta{display:flex;gap:20px;color:#7f8c8d;font-size:.9rem;margin-bottom:15px}.article-content{line-height:1.8}.article-content h2{font-size:1.6rem;margin:2rem 0 1rem;padding-bottom:.5rem;border-bottom:1px solid var(--border-color);scroll-margin-top:calc(var(--nav-height) + 20px)}.article-content h3{font-size:1.3rem;margin:1.5rem 0 .8rem;scroll-margin-top:calc(var(--nav-height) + 20px)}.article-content img{max-width:100%;height:auto;border-radius:6px;margin:1.5rem 0;box-shadow:0 3px 10px rgba(0,0,0,.1)}.article-content pre{position:relative;background:#f7f7f7;color:#242424;border-left:4px solid #04b04f;border-radius:8px;padding:1.5rem 1rem 1rem;margin:1.5rem 0;overflow:auto;box-shadow:0 1px 3px rgba(0,0,0,.1);max-height:40vh;white-space:pre-wrap;font-family:fira code,Menlo,Monaco,Consolas,monospace;font-size:.9rem;line-height:1.5;scrollbar-width:thin;scrollbar-color:#c4c4c4 #f7f7f7}.article-content code{font-family:inherit;color:inherit !important;background:0 0 !important;padding:0;text-shadow:none !important;font-size:.9rem}.hljs-meta,.hljs-built_in{color:#04b04f}.hljs-attribute{color:#e91e63}.hljs-string{color:#2e7d32}.hljs-number{color:#2196f3}.article-content pre::-webkit-scrollbar{width:12px;height:12px}.article-content pre::-webkit-scrollbar{width:12px;height:12px}.article-content pre::-webkit-scrollbar-thumb{background:#04b04f;opacity:.6;border:3px solid #f7f7f7}.article-content pre::-webkit-scrollbar-track{background:#f7f7f7;border-radius:6px}.copy-code{position:absolute;top:10px;right:15px;background:rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.2);color:#242424;border-radius:4px;padding:3px 8px;font-size:.8rem;cursor:pointer;transition:all .3s;opacity:0;z-index:10}pre:hover .copy-code{opacity:1}.copy-code:hover{background:rgba(0,0,0,.2)}.copy-code.copied{background:#28a745;color:#fff;border-color:#28a745}@media(max-width:1024px){.toc-container{width:240px;padding:15px}.content-container{padding:25px}}@media(max-width:768px){.main-container{flex-direction:column}.toc-container{position:static;width:100%;margin-right:0;margin-bottom:30px;max-height:none}.article-title{font-size:1.8rem}.article-content pre{max-height:50vh;padding-right:10px}}</style></head><body><nav class=top-nav><div class=nav-container><a href=/ class=site-title>技术博客</a><div class=nav-links><a href=/>首页</a>
<a href=/posts/>所有文章</a>
<a href=/categories/>分类</a>
<a href=/tags/>标签</a></div></div></nav><div class=main-container><aside class=toc-container><h3 class=toc-title>目录</h3><div class=toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#使用winpe的三种方法>使用WINPE的三种方法</a></li></ul></li></ul></li></ul></nav></div></aside><article class=content-container><header class=article-header><h1 class=article-title>使用wimBuilder2制作winpe</h1><div class=article-meta><span>📅 2023年6月17日</span></div></header><div class=article-content><h4 id=使用winpe的三种方法>使用WINPE的三种方法</h4><h5 id=网上下载winpe>网上下载WINPE</h5><p>​ 经常使用的WINPE有IT天空的WINPE、<a href=https://www.wepe.com.cn/>微PE工具箱</a></p><h5 id=使用工具制作winpe>使用工具制作WINPE</h5><p>以前使用过winbuilder制作过，经常遇到因为环境不匹配导致的错误，找问题很费时间和精力，就放弃了。后来遇到了wimbuilder2，目前在github上开源。这里就简单记录一下使用wimbuilder2的使用要点：</p><p><img src=images/prepare.png alt=img></p><p><img src=images/custome.png alt=img></p><p><img src=images/build.png alt=img></p><p>制作好winpe之后，发现有自己需要而winpe中不包含的软件，如何添加呢</p><h6 id=自定义添加自己需要的软件>自定义添加自己需要的软件</h6><p>自己对wimbuilder2不熟悉，此项目设计到大量批处理、自定义宏，还有javascript、css、html知识，还有作者自定义的用c语言构造的支持文件。在做好winpe之后，一个真实的需求就是添加自定义的软件，在桌面显示软件的快捷方式或者添加到开始菜单。可是在wimbuilder里愣是没有找到详细的说明，自己水平有限吧，还没有通过wimbuilder2自带的范例学明白，无奈，翻阅github上wimbuilder源项目issue,<a href=https://github.com/slorelee/wimbuilder2/issues/79>第79号issue</a>,应该是外国人提问的一个问题，和我的想法一样，看完照着做居然做好了。下面是这个issue的详细内容:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>A:How to install apps ? Could we have a tutorial, we want to put in on the desktop, could it be in English? <span class=o>(</span>Or French, it would be best<span class=o>)</span>
</span></span><span class=line><span class=cl>Thank you <span class=k>for</span> your <span class=nb>time</span> and help! <span class=o>=)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Q:For Windows PE, I think a portable version of the application is good, you can run them from your USB disk directly.
</span></span><span class=line><span class=cl>About the shortcuts on Desktop, the PETools loader should <span class=nb>read</span> a U:<span class=se>\P</span>ETools<span class=se>\P</span>ETools.ini, the pecmd.exe<span class=s1>&#39;s link command
</span></span></span><span class=line><span class=cl><span class=s1>will create a shortcut for it.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>If you want to create a shortcut when building with WimBuilder2.
</span></span></span><span class=line><span class=cl><span class=s1>You can see the sample in:
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>E:\WimBuilder2\Projects\WIN10XPE\02-Apps
</span></span></span><span class=line><span class=cl><span class=s1>- 7-Zip\main.bat
</span></span></span><span class=line><span class=cl><span class=s1>- Defraggler\main.bat
</span></span></span><span class=line><span class=cl><span class=s1>- PENetwork\main.bat
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>call LinkToDesktop &#34;7-Zip.lnk&#34; &#34;#pProgramFiles#p\7-Zip\7zFM.exe&#34;
</span></span></span><span class=line><span class=cl><span class=s1>call LinkToStartMenu &#34;7-Zip\7-Zip File Manager.lnk&#34; &#34;#pProgramFiles#p\7-Zip\7zFM.exe&#34;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>call LinkToStartMenu &#34;Defraggler\%APP_NAME%.lnk&#34; &#34;#pProgramFiles#p\Defraggler\Defraggler.exe&#34;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>call LinkToDesktop PENetwork.lnk &#34;#pProgramFiles#p\PENetwork\PENetwork.exe&#34;
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>#p is instead of the % mark to avoid to use the hostOS&#39;</span>s enviroment variables.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can right click on next item node. and <span class=k>select</span> <span class=o>[</span>open the folder<span class=o>]</span>, or <span class=o>[</span>edit the last.bat<span class=o>]</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_Personal-Tailor_<span class=o>(</span>Post<span class=o>)</span>
</span></span><span class=line><span class=cl>        MyStartMenu
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WimBuilder2<span class=se>\A</span>ppData<span class=se>\P</span>rojects<span class=se>\W</span>IN10XPE<span class=se>\1</span>0-MyCustom<span class=se>\M</span>yStartMenu<span class=se>\l</span>ast.bat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>call LinkToDesktop <span class=s2>&#34;7-Zip.lnk&#34;</span> <span class=s2>&#34;#pProgramFiles#p\7-Zip\7zFM.exe&#34;</span>
</span></span><span class=line><span class=cl>call PinToTaskbar <span class=s2>&#34;#pProgramFiles#p\Everything\Everything.exe&#34;</span>
</span></span><span class=line><span class=cl>call PinToStartmenu <span class=s2>&#34;#pProgramFiles#p\WinXShell\WinXShell.exe&#34;</span>
</span></span><span class=line><span class=cl>call PinToStartmenu regedit.exe
</span></span></code></pre></div><p>按照上面的问答，在wimbuilder2定制界面，鼠标右击开始菜单，选择编辑last.bat文件，桌面显示diskgenius.exe快捷方式。修改后的last.bat文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rem rd /s /q <span class=s2>&#34;%X%\ProgramData\Microsoft\Windows\Start Menu\Programs\Accessories&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> exist SIB_RegDefault.reg <span class=o>(</span>
</span></span><span class=line><span class=cl>    reg import SIB_RegDefault.reg
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rem   在桌面添加diskgenius.link这个快捷方式。
</span></span><span class=line><span class=cl>rem   把diskgenius<span class=se>\d</span>iskgenius.exe保存在WimBuilder2-Full.v2021-11-11<span class=se>\v</span>endor<span class=se>\_</span>PEMaterial_<span class=se>\P</span>rogram Files<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>rem   最终的路径为C:<span class=se>\W</span>imBuilder2-Full.v2021-11-11<span class=se>\v</span>endor<span class=se>\_</span>PEMaterial_<span class=se>\P</span>rogram Files<span class=se>\d</span>iskgenius<span class=se>\d</span>iskgenius.exe
</span></span><span class=line><span class=cl>rem   可以用同样的方法添加其他自定义软件，如果是单文件可执行文件，也是可以放在 ..<span class=se>\v</span>endor<span class=se>\_</span>PEMaterial_<span class=se>\P</span>ortableApps目录下面试试
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>call LinkToDesktop <span class=s2>&#34;DiskGenius.lnk&#34;</span> <span class=s2>&#34;#pProgramFiles#p\diskgenius\diskgenius.exe&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rem 下面这两句是把diskgenius显示在开始菜单
</span></span><span class=line><span class=cl>call PinToStartmenu <span class=s2>&#34;X:\Program Files\diskgenius\diskgenius.exe&#34;</span>
</span></span><span class=line><span class=cl>call PinToStartmenu regedit.exe
</span></span></code></pre></div><p>总结一下添加自定义软件及快捷方式的方法：</p><ul><li><p>自定义软件的保存路径</p><ul><li><p>单文件可执行程序放在项目的..\vendor_PEMaterial_\PortableApps目录下面</p></li><li><p>其他程序放在..\vendor_PEMaterial_\Program Files\目录下</p></li></ul></li><li><p>添加快捷方式或者添加到开始菜单</p><ul><li>鼠标右击【我的定制(后置)】下面的开始菜单(MyStartMenu),选择编辑last.bat,在文件中添加快捷方式。具体可以参照项目中的关于软件配置的例子写法。</li></ul></li></ul><h6 id=使用ultraiso制作可启动u盘>使用UltraISO制作可启动U盘</h6><p>使用UltraISO把制作好的ISO文件写入到U盘，就可以使用U盘启动进入winpe。写入方法如下：</p><ul><li>以管理员的方式运行UltraISO</li><li>选择File\open菜单打开winpe的ISO文件</li><li>选择启动\写入硬盘映像</li><li>确认好U盘的盘符，使用HDD++的方式写入U盘（U盘会被格式，制作前要确认U盘上没有重要数据）</li></ul><p><img src=images/ultraiso_open.png alt=img>
<img src=images/%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E6%98%A0%E5%83%8F.png alt=img></p><h6 id=自定义制作完成的winpe桌面背景>自定义制作完成的Winpe桌面背景</h6><p>在WimBuilder2的设置界面里设置好winpe桌面背景之后，启动时可以正常显示，启动完毕后，就换成另外一个wimbuilder2自带的一个背景。以换桌面为例，顺带复习一下UltraISO修改启动镜像的简单步骤，好久不用了，差点忘记了，这里记录备忘。</p><ul><li><p>使用UltraISO打开WimBuilder2生成的bootpe.iso文件，把sources\boot.wim释放到自定义的目录下，然后使用<code>dism /mount-image /imagefile:dirname/boot.wim /index:1 /mountdir:c:\mnt </code>把boot.wim装载到c:\mnt下。在根目录下有个PEMaterial文件夹，下面保存着wallpaper.jpg，这个图片文件就是wimbuilder2制作的winpe启动后显示的桌面背景，更换成自己喜欢的背景图片，然后再使用<code>dism /unmount-image /mountdir:c:\mnt /commit</code>打包，更新后的boot.wim直接拖放到UltraISO中原boot.wim所在的路径。</p></li><li><p>不要直接解压这个WimBuilder2制作好的BOOTPE.ISO，解压后再修改boot.wim文件，在打包成ISO时发现启动信息错误，又要按照制作启动盘的方法重新导入启动信息再打包，有点麻烦了。所以就是用UltraISO直接打开BOOTPE.ISO，然后把boot.wim释放出来修改，修改后再放回到原来的位置保存即可。一句话，在保持BOOTPE.ISO的启动框架下修改boot.wim会简单点，要不然就需要重新制作启动盘的操作了。</p></li></ul><p><img src=images/ultraiso.png alt=img></p></div></article></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e);const t=document.createElement("button");t.className="copy-code",t.textContent="Copy",t.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{t.textContent="Copied!",t.classList.add("copied"),setTimeout(()=>{t.textContent="Copy",t.classList.remove("copied")},2e3)})}),e.parentElement.prepend(t)});const o=document.querySelectorAll(".article-content h2[id], .article-content h3[id]"),i=document.querySelectorAll('.toc a[href^="#"]'),a=document.querySelector(".top-nav").offsetHeight,n=document.querySelector(".toc-container"),e=[];o.forEach(t=>{e.push({id:t.id,top:t.offsetTop-a-20})});function s(){const s=window.scrollY;let t="";for(let n=e.length-1;n>=0;n--)if(e[n].top<=s+50){t=e[n].id;break}i.forEach(e=>{const s=e.getAttribute("href")===`#${t}`;if(e.classList.toggle("active",s),s){const t=e.offsetTop-n.clientHeight/2;n.scrollTop=t}})}let t=!1;window.addEventListener("scroll",()=>{t||(window.requestAnimationFrame(()=>{s(),t=!1}),t=!0)}),s()})</script></body></html>